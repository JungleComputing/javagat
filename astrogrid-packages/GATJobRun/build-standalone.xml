<project name    = "GATJobRun"
         default = "build"
         basedir = ".">

  <description>
    Builds the project GATJobRun.
  </description>

  <!-- Get the path to the JavaGAT engine libraries.
       For this, GAT_LOCATION must be set. -->
  <property environment = "env" />

  <!-- getting pwd -->
  <property name = "currdir" location = "${env.PWD}" />

  <!-- getting SGE_ROOT -->
  <property name = "sgeroot" location = "${env.SGE_ROOT}" />



  <fail message = "Environment variable ${GAT_LOCATION} must be set !">
    <condition>
      <equals
        arg1 = "${env.GAT_LOCATION}"
        arg2 = "$${env.GAT_LOCATION}"
      />
    </condition>
  </fail>

  <!-- Check that it really points to a JavaGAT installation -->
  <available file     = "${env.GAT_LOCATION}"
             type     = "dir"
             property = "gat_dir"
             value    = "${env.GAT_LOCATION}" />

  <fail message = "Environment variable ${GAT_LOCATION} doesn't seem to point to a JavaGAT installation !"
        unless  = "gat_dir" />

  <!-- Check path to external jars -->
  <available file     = "${env.GAT_LOCATION}/adaptors/external"
             type     = "dir"
             property = "gat_adaptors_external_dir"
             value    = "${env.GAT_LOCATION}/adaptors/external" />

  <fail message = "External jars for the build not found !"
        unless  = "gat_adaptors_external_dir" />

<!-- <property name = "srcdir"   location = "${currdir}/src/gatjobrun" />
  <property name = "builddir" location = "${currdir}/build/classes" />
  <property name = "distdir"  location = "${currdir}/dist" />-->

  <property name = "srcdir"   location = "src" />
  <property name = "builddir" location = "build/classes" />
  <property name = "distdir"  location = "dist" />


  <path id = "gat_engine_jars_path">
    <fileset id  = "gat_engine_jars"
             dir = "${gat_dir}">
      <include name = "lib/GAT-API.jar" />
      <include name = "lib/GAT-engine.jar" />
      <include name = "lib/colobus.jar" />
      <include name = "lib/commons-logging-1.1.jar" />
      <include name = "lib/log4j-1.2.13.jar" />
      <include name = "lib/ibis-util-1.4.jar" />
      <include name = "lib/castor-1.1.1-xml.jar" />
      <include name = "lib/xercesImpl.jar" />
      <include name = "lib/xmlParserAPIs.jar" />
      <include name = "lib/drmaa.jar" />
    </fileset>
  </path>

  <path id = "gat_adaptors_external_jars_path">
    <fileset id  = "gat_adaptors_external_jars"
             dir = "${gat_adaptors_external_dir}">
      <include name = "drmaa.jar" />
    </fileset>
  </path>

  <path id = "gat_wsgt4_config_path">
    <fileset id  = "gat_wsgt4_config"
             dir = "/opt/globus">
      <include name = "client-config.wsdd" />
    </fileset>
  </path>

  <target name        = "build"
          depends     = "clean"
          description = "build the JARs">
    <!-- Create the target directory -->
    <mkdir dir = "${builddir}" />

    <!-- Compile the java code from ${srcdir} into ${builddir} -->
    <javac srcdir  = "${srcdir}"
           destdir = "${builddir}"
           debug   = "on" >
      <classpath refid = "gat_engine_jars_path" />
    </javac>

    <!-- Create the distribution directory
         and copy external libraries into it -->
    <mkdir dir = "${distdir}" />
    <copy todir="${distdir}">
      <fileset refid="gat_engine_jars" />
    </copy>
    <copy todir="${distdir}/lib">
      <fileset refid="gat_adaptors_external_jars" />
    </copy>

    <!-- Create the JAR from ${builddir} classes -->
    <jar jarfile = "${distdir}/GATJobRun.jar">
      <fileset dir = "${builddir}" />
      <fileset file = "log4j.properties" />
      <manifest>
        <attribute name  = "Main-Class"
                   value = "gatjobrun.Main" />
        <attribute name  = "Class-Path"
                   value = "${currdir}/dist/lib/GAT-API.jar ${currdir}/dist/lib/GAT-engine.jar ${currdir}/dist/lib/colobus.jar ${currdir}/dist/lib/commons-logging-1.1.jar ${currdir}/dist/lib/log4j-1.2.13.jar ${currdir}/dist/lib/castor-1.1.1-xml.jar ${currdir}/dist/lib/xercesImpl.jar ${currdir}/dist/lib/xmlParserAPIs.jar ${currdir}/dist/lib/drmaa.jar ${currdir}/dist/lib/ibis-util-1.4.jar ${sgeroot} ${gat_wsgt4_config}"  />
      </manifest>
    </jar>

    <!-- Create the JAR for GATJobOperation from ${builddir} classes -->
    <jar jarfile = "${distdir}/GATJobOperation.jar">
      <fileset dir = "${builddir}" />
      <fileset file = "log4j.properties" />
      <manifest>
        <attribute name  = "Main-Class"
                   value = "gatjobstatus.JobStateMain" />
        <attribute name  = "Class-Path"
                   value = "${currdir}/dist/lib/GAT-API.jar ${currdir}/dist/lib/GAT-engine.jar ${currdir}/dist/lib/colobus.jar ${currdir}/dist/lib/commons-logging-1.1.jar ${currdir}/dist/lib/log4j-1.2.13.jar ${currdir}/dist/lib/castor-1.1.1-xml.jar ${currdir}/dist/lib/xercesImpl.jar ${currdir}/dist/lib/xmlParserAPIs.jar ${currdir}/dist/lib/drmaa.jar ${currdir}/dist/lib/ibis-util-1.4.jar ${sgeroot}  ${gat_wsgt4_config_path}"  />
      </manifest>
    </jar>

    <echo level ="info">
        SGE_ROOT = '${sgeroot}' found. If empty, you can't submit jobs to SGE. 
        Please set SGE_ROOT and rebuild GATJobRun, if you like to use SGE
     </echo>


  </target>

  <target name = "clean" description = "clean up">
    <delete dir = "${builddir}"/>
    <delete dir = "${distdir}"/>
  </target>

</project>
