\section{Source/API}
\subsection{Advert.java}
\begin{code}
public class Advert {
	
	private Communications comm = null;
	
	public Advert(String server, String user, String passwd) 
	  throws AuthenticationException, IOException {
		comm = new Communications(server, user, passwd);
	}
	
	/**
	 * Add a {@link byte}[] to the App Engine, at an absolute path, with
	 * {@link MetaData} included, to the datastore. If an entry exists at the
	 * specified path, that entry gets overwritten, and a warning is issued.
	 * 
	 * @param bytes
	 *            {@link byte}[] to be stored.
	 * @param metaData
	 *            {@link MetaData} to be associated with the passed bytes.
	 * @param path
	 *            Absolute path of the new entry.
	 * @throws AppEngineResourcesException
	 *             This exception is thrown when the App Engine runs out of
	 *             resources.
	 */
	public void add(byte[] object, MetaData metaData, String path) 
	  throws MalformedURLException, IOException, AuthenticationException,
	  AppEngineResourcesException, NoSuchElementException, 
	  RequestTooLargeException {
		JSONArray  jsonarr = new JSONArray();
		JSONObject jsonobj = new JSONObject();

		Iterator<String> itr  = metaData.getAllKeys().iterator();
	
		while (itr.hasNext()) {
			String key   = itr.next();
			String value = metaData.get(key);

			if (key == null) {
				continue; //key can't be null (value can)
			}
			
			jsonobj.put(key, value);
		}
		
		String base64 = new sun.misc.BASE64Encoder().encode(object);
		
		jsonarr.add(path);
		jsonarr.add(jsonobj);
		jsonarr.add(base64);
		
		comm.httpSend("/add", jsonarr.toString());
		
        /*
         * TODO: return TTL of data stored at server (optional)?
         */
	}
	

	/**
	 * Remove an instance and related {@link MetaData} from the datastore at an
	 * absolute path.
	 * 
	 * @param path
	 *            Path is an absolute entry to be deleted.
	 * @throws NoSuchElementException
	 *             The path is incorrect.
	 */
	public void delete(String path) 
	  throws MalformedURLException, IOException, AuthenticationException,
	  AppEngineResourcesException, NoSuchElementException, 
	  RequestTooLargeException {
		comm.httpSend("/del", path);
	}

	/**
	 * Gets an instance from the datastore at a given (absolute) path.
	 * 
	 * @param path
	 *            Absolute path of the entry.
	 * @return The instance at the given path.
	 * @throws NoSuchElementException
	 *             The path is incorrect.
	 */
	public byte[] get(String path) 
	  throws MalformedURLException, IOException, AuthenticationException,
	  AppEngineResourcesException, NoSuchElementException, 
	  RequestTooLargeException {
		String base64 = comm.httpSend("/get", path);
		
		return new sun.misc.BASE64Decoder().decodeBuffer(base64);
	}

	/**
	 * Gets the {@link MetaData} of an instance from the given (absolute) path.
	 * 
	 * @param path
	 *            Absolute path of the entry.
	 * @return A {@link MetaData} object containing the meta data.
	 * @throws NoSuchElementException
	 *             The path is incorrect.
	 */
	public MetaData getMetaData(String path) 
	  throws MalformedURLException, IOException, AuthenticationException,
	  AppEngineResourcesException, NoSuchElementException, 
	  RequestTooLargeException {
		MetaData   metadata = new MetaData();
		
		String result = comm.httpSend("/getmd", path);
		
		JSONObject jsonobj = JSONObject.fromObject(result);
		Iterator<?> itr    = jsonobj.keys();
		
		while (itr.hasNext()) {
			String key   = (String)itr.next();
			String value = (String)jsonobj.get(key);

			if (key == null) {
				continue; //key can't be null (value can)
			}
			
			metadata.put(key,value);
		}

		return metadata;
	}

	/**
	 * Query the App Engine for entries matching the specified set of
	 * {@link MetaData}.
	 * 
	 * @param metaData
	 *            {@link MetaData} describing the entries to be searched for.
	 *            No wildcards allowed.
	 * @param pwd
	 *            Current working path.
	 * @return a {@link String}[] of absolute paths, each pointing to a
	 *         matching entry. If no matches are found, null is returned.
	 */
	public String[] find(MetaData metaData, String pwd)
	  throws MalformedURLException, IOException, AuthenticationException,
	  AppEngineResourcesException, NoSuchElementException, 
	  RequestTooLargeException {
		JSONObject metadata = new JSONObject();
		JSONArray  jsonarr  = new JSONArray();
		
		Iterator<String> itr  = metaData.getAllKeys().iterator();
		
		while (itr.hasNext()) {
			String key   = itr.next();
			String value = metaData.get(key);

			if (key == null) {
				continue; //key can't be null (value can)
			}
			
			metadata.put(key, value);
		}
				
		String result = comm.httpSend("/find", metadata.toString());
		
		jsonarr = JSONArray.fromObject(result);
		
		return (String[]) jsonarr.toArray();
	}
}
\end{code}

\subsection{Communications.java}
\begin{code}
class Communications {
	
	private static final int MAX_REQ_SIZE = 10000000;
	private static final int MAX_DB_SIZE  = 1000000;
	
	private String cookie;
	private String server;
	
	Communications(String server, String user, String passwd) 
	  throws MalformedURLException, ProtocolException, IOException, 
	  AuthenticationException {
		this.server = server;
		authenticate(user, passwd);
	}
	
	private static final String CLIENTLOGIN = 
		"https://www.google.com/accounts/ClientLogin";
	
	/**
	 * Function to set up SSL in the system properties. 
	 */
	private static void setupSsl() {
	
	}
	
	/**
	 * Function to authenticate to the Google App Engine
	 * @param server
	 * 				Server to connect to.
	 * @param user
	 * 				User's email address for identification.
	 * @param passwd
	 * 				User's password for identification.
	 * @return a {@link String} which contains a cookie with a session ID.
	 * @throws Exception
	 * 				Failed to authenticate to the App Engine.
	 */
	void authenticate(String user, String passwd) 
	  throws MalformedURLException, ProtocolException, IOException, 
	  AuthenticationException {

	}
	
	/**
	 * Function to send an object over HTTP.
	 * @param server
	 * 				Server to send the object to.
	 * @param cookie
	 * 				Cookie for identification.
	 * @param object
	 * 				Object to be send to the server.
	 * @return
	 * 				Returns the response body in {@link String} format.
	 * @throws Exception
	 * 				Failed to send object to server.
	 */
	String httpSend(String ext, String payload) 
	  throws MalformedURLException, IOException, AuthenticationException,
	  AppEngineResourcesException, NoSuchElementException, 
	  RequestTooLargeException {

	}
}
\end{code}

\subsection{ibis-advert.py}
\begin{code}
import cgi

from google.appengine.api import users
from google.appengine.ext import webapp
from google.appengine.ext.webapp.util import run_wsgi_app
from google.appengine.ext import db
from django.utils import simplejson 

class Advert(db.Model):
  path   = db.StringProperty()
  author = db.UserProperty()
  ttl    = db.DateTimeProperty(auto_now_add=True)
  object = db.TextProperty() #base64
  
  def delmd(self): #delete all metadata of some object
    query = db.GqlQuery("SELECT * FROM MetaData WHERE path = :1", self.path)
    
    for md in query:
      md.delete()

class MetaData(db.Model):
  path   = db.StringProperty()
  keystr = db.StringProperty()
  value  = db.StringProperty()

def auth(self): #authentication
  if not users.get_current_user():
    self.error(403)
    self.response.headers['Content-Type'] = 'text/plain'
    self.response.out.write('Not Authenticated')
    return -1

  if not users.is_current_user_admin():
    self.error(403)
    self.response.headers['Content-Type'] = 'text/plain'
    self.response.out.write('No Administrator')
    return -1

  return 0

def gc(): #garbage collector
  query = db.GqlQuery("SELECT * FROM Advert WHERE ttl < :1", datetime.datetime.today() + datetime.timedelta(days=-10))
  
  for advert in query: #all entities that can be deleted
    advert.delmd()     #delete all associated metadata
    advert.delete()    #delete the object itself

class MainPage(weba0pp.RequestHandler):
  def get(self):
    self.redirect(users.create_login_url(self.request.uri))

class AddObject(webapp.RequestHandler):
  def post(self):
    advert = Advert()
    user   = users.get_current_user()
    
    if auth(self) < 0: return
    
    body = self.request.body
    json = simplejson.loads(body)
    
    query = db.GqlQuery("SELECT * FROM Advert WHERE path = :1", json[0])
    if query.count() > 0: #this entry already exists; overwrite
      query.delmd()  #delete all associated metadata
      query.delete() #delete the object itself
      self.response.http_status_message(205) #reset content
    
    advert.path   = json[0] #extract path from message
    advert.author = user    #store author
    advert.object = json[2] #extract (base64) object from message
    
    advert.put() #store object in database
    
    for k in json[1].keys():
      metadata        = MetaData(parent=advert)
      metadata.path   = json[0]
      metadata.keystr = k
      metadata.value  = json[1][k]
      metadata.put()
    
    self.response.http_status_message(201) #Created
    self.response.headers['Content-Type'] = 'text/plain'
    self.response.out.write('Expires: %s', datetime.datetime.today() + datetime.timedelta(days=10)) 
    return

class DelObject(webapp.RequestHandler):
  def post(self):
    if auth(self) < 0: return
    
    body  = self.request.body
    query = db.GqlQuery("SELECT * FROM Advert WHERE path = :1", body)
    
    if query.count() < 1: #no matching object found
      self.error(404)
      self.response.headers['Content-Type'] = 'text/plain'
      self.response.out.write('No Such Element')
      return      
    
    for advert in query:
      advert.delmd()  #delete all associated metadata
      advert.delete() #deleting the first entry we find
      break #and stop
  
    self.response.headers['Content-Type'] = 'text/plain'
    self.response.out.write('OK')
    
class GetObject(webapp.RequestHandler):
  def post(self):
    if auth(self) < 0: return
    
    body  = self.request.body
    query = db.GqlQuery("SELECT * FROM Advert WHERE path = :1", body)
    
    if query.count() < 1: #no matching object found
      self.error(404)
      self.response.headers['Content-Type'] = 'text/plain'
      self.response.out.write('No Such Element')
      return      
    
    for advert in query:
      self.response.headers['Content-Type'] = 'text/plain'
      self.response.out.write(advert.object) #returning the first entry we find
      break #and stop
    
    return;
  
class GetMetaData(webapp.RequestHandler):
  def post(self):
    if auth(self) < 0: return
    
    body  = self.request.body
    query = db.GqlQuery("SELECT * FROM MetaData WHERE path = :1", body)
    
    if query.count() < 1: #no matching object found
      self.error(404)
      self.response.headers['Content-Type'] = 'text/plain'
      self.response.out.write('No Such Element')
      return
    
    jsonObject = {}
    
    for metadata in query:
      jsonObject[metadata.keystr] = metadata.value
      
    self.response.headers['Content-Type'] = 'text/plain'
    self.response.out.write(simplejson.dumps(jsonObject))   

class FindMetaData(webapp.RequestHandler):
  def post(self):
    if auth(self) < 0: return
    
    body = self.request.body
    json = simplejson.loads(body)
    
    query = db.GqlQuery("SELECT * FROM MetaData")
    
    paths = Set()
    
    for bin in query:
      paths.add(bin.path)
      
    paths  = list(paths)
    self.response.out.write(paths)
    
    for path in paths[:]:
      for k in json.keys():
        query = db.GqlQuery("SELECT * FROM MetaData WHERE path = :1 AND keystr = :2 AND val = :3", path, k, json[k])
        if query.count() < 1:
          paths.remove(path)
          break
    
    if len(paths) < 1:
      self.error(404)
      self.response.headers['Content-Type'] = 'text/plain'
      self.response.out.write('Not Found')
      return
    
    self.response.out.write(simplejson.dumps(paths))  

application = webapp.WSGIApplication(
                                     [('/',      MainPage),
                                      ('/add',   AddObject),
                                      ('/del',   DelObject),
                                      ('/get',   GetObject),
                                      ('/getmd', GetMetaData),
                                      ('/find',  FindMetaData)],
                                     debug=True)

def main():
  run_wsgi_app(application)

if __name__ == "__main__":
  main()
\end{code}